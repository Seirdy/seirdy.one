{{- $wbmLinks := (slice "https://si3t.ch/log/2021-04-18-entetes-floc.html" "https://xmpp.org/2021/02/newsletter-02-feburary/" "https://gurlic.com/technology/post/393626430212145157" "https://gurlic.com/technology/post/343249858599059461" "https://www.librepunk.club/@penryn/108411423190214816" "https://benign.town/@josias/108457015755310198" "http://www.tuxmachines.org/node/148146" "https://i.reddit.com/r/web_design/comments/k0dmpj/an_opinionated_list_of_best_practices_for_textual/gdmxy4u/" "https://bbbhltz.space/posts/thoughts-on-tech-feb2021/" "https://jorts.horse/@alice/108477866954580532" "https://brid.gy/comment/mastodon/@Seirdy@pleroma.envs.net/AK7FeQ4h2tUCKNwlXc/AK7GtGkE7JOVgm1Cgi" "https://fosstodon.org/@werwolf/108529382741681838" "https://mastodon.social/@WahbAllat/108986614624476982" "https://linuxrocks.online/@friend/109029028283860044" "https://fosstodon.org/@fullstackthaumaturge/108765040526523487" "https://inhji.de/notes/an-opinionated-list-of-best-practices-for-textual-websites" "https://ravidwivedi.in/whatsapp/" "https://hackers.town/@theruran/108440680870400884" "https://hackers.town/@theruran/108440475936938471" "https://mckinley.cc/twtxt/2022-may-aug.html#2022-06-25T16:06:07-07:00" "https://tarnkappe.info/lesetipps-bayern-it-sicherheit-db-app-trackt-neue-eu-datenbank/" "https://catcatnya.com/@kescher/109221687024062842" "https://catcatnya.com/@kescher/109221707054861018" "https://catcatnya.com/@kescher/109221721385520640" "https://catcatnya.com/@kescher/109221750082044200" "https://brid.gy/post/twitter/seirdy/1536747178877673475" "https://markesler.com/blog/website-design/" "https://catcatnya.com/@kescher/108601418196537980" "https://chaos.social/@n0toose/109035270210401105" "https://nicfab.it/en/posts/aware-digital-communication-respecting-privacy-and-the-apps-or-services-you-choose/" "https://haxf4rall.com/2022/09/23/a-collection-of-articles-about-hardening-linux/") -}}
{{- $archivetodayLinks := (slice "https://example.com") -}}
{{- $rewritesDict := dict "" "" -}}
{{- range $i, $r := (getCSV "," "/csv/rewrites.csv") -}}
	{{- $rewritesDict = merge $rewritesDict (dict (index $r 0) (index $r 1)) -}}
{{- end -}}
<h3 id="webmentions" tabindex="-1">Web&#173;mentions</h3>
<p>This site supports <a href="https://indieweb.org/webmention">Webmentions</a>, a backlink-based alternative to traditional comment forms.</p>
{{ partial "webmention-form.html" . }}
{{- $target := .RelPermalink | replaceRE "^/~seirdy/" "/" }}
{{ $url1 := printf "https://seirdy.one/webmentions/get?status=approved&target=https://seirdy.one%s" $target -}}
{{ $webmentions := (getJSON $url1) -}}
{{- if lt .Date.Unix 1653616670 -}}{{- /* commit c84c8d4 changed my URL schemes, so fetch menchies for the legacy scheme on old posts. */ -}}
	{{- $oldTarget := $target | replaceRE "/posts" "" | replaceRE "/$" ".html" -}}
	{{- $url2 := printf "https://seirdy.one/webmentions/get?status=approved&target=https://seirdy.one%s" $oldTarget -}}
	{{- $webmentions = $webmentions | append (getJSON $url2) -}}
{{- end -}}
{{- if gt (len $webmentions) 0 -}}
<p>Webmentions received for this post appear in the following list after I approve them. I sometimes send Webmentions to myself on behalf of linking sites that don’t support them. I auto-replace broken links with <a href="https://web.archive.org/">Wayback Machine</a> snapshots, if they exist.</p>
<details>
	<summary>Toggle Webmentions</summary>
	<dl>
		{{ range sort $webmentions "created_at" -}}
		{{ $webmention := . -}}
			{{- /* Boolean: should we should handle this webmention like a comment or a linkback? */ -}}
			{{- $hasContent := and (isset $webmention "content") (gt (countrunes $webmention.content) 50) -}}
			{{- $title := $webmention.title -}}
			{{- /* Remove extraneous crap from Fediverse webmentions */ -}}
			{{- if findRE "@Seirdy" $webmention.title -}}
				{{- $title = $title | replaceRE `^@Seirdy@pleroma.envs.net(\n| )?` "" -}}
				{{- /* Mastodon webmentions may include the author in the title followed by a colon; this is redundant. */ -}}
				{{- if and (isset $webmention "author_name") (findRE `@` $webmention.source) (not (findRE "^https://bridg.gy" $webmention.source)) -}}
					{{ $title = $title | replaceRE `^[^:]{0,20}: ?` "" | replaceRE `^"@Seirdy@pleroma.envs.net ?` `"` }}
				{{- end -}}
			{{- end -}}
			{{- if and ($hasContent) (gt (countrunes $webmention.title) 128) -}}
				{{- $title = $webmention.title | strings.TrimSuffix "…" | truncate 128 -}}
			{{- end -}}
			{{- $src := $webmention.source -}}
			{{- with index $rewritesDict $src -}}
				{{- $src = . -}}
			{{- end -}}
			{{- if in $wbmLinks $src -}}
				{{- $src = printf "https://web.archive.org/web/0/%s" $src -}}
			{{- else if in $archivetodayLinks $src -}}
				{{- $src = printf "https://archive.today/oldest/%s" $src -}}
			{{- end -}}
			{{ if (eq $webmention.type "like") -}}
			<div itemprop="potentialAction" itemscope="" itemtype="https://schema.org/LikeAction" class="u-like h-cite">
			{{- else -}}
			<div itemprop="comment" itemscope="" itemtype="https://schema.org/Comment" class="u-comment h-cite">
			{{- end -}}
			<!--Will eventually add role="comment" once WAI-ARIA 1.3 starts seeing some adoption.-->
				<dt>
					<time
						class="dt-published"
						itemprop="{{ if (eq $webmention.type "like") -}}startTime{{ else }}datePublished{{ end }}"
						datetime="{{ dateFormat "2006-01-02 15:04:05Z07:00" $webmention.created_at }}">
						{{ dateFormat "2006-01-02" $webmention.created_at }}
					</time>
				</dt>
				<dd>
					{{ if (eq $webmention.type "like") -}}
						{{ if $webmention.author_name -}}
							<span itemprop="agent" itemscope="" itemtype="https://schema.org/Person" class="h-card p-author vcard"><span itemprop="name" class="p-name fn n">{{ $webmention.author_name }}</span></span>
						{{ else if $webmention.title -}}
							<span itemprop="name" class="p-name">{{ $webmention.title | replaceRE ` \n` `
` -}}</span>
						{{ else -}}
							{{ $webmention.source | strings.TrimPrefix "https://" | strings.TrimPrefix "www." | strings.TrimRight "/" | truncate 35 -}}
						{{ end -}}
							<a class="u-url" itemprop="url" href="{{ $src }}" rel="nofollow ugc">liked</a> this
					{{ else -}}
						<a class="u-url" itemprop="url" href="{{ $src }}" rel="nofollow ugc">
							<span itemprop="name" class="p-name">
								{{ if $webmention.title -}}
									{{ $title | truncate 200 | replaceRE ` \n` `
` | safeHTML -}}
								{{ else -}}
									{{- $webmention.source | strings.TrimPrefix "https://" | strings.TrimPrefix "www." | strings.TrimRight "/" | truncate 35 -}}
								{{ end -}}
							</span
						></a>
						{{- if $webmention.author_name }}
						by <span itemprop="author" itemscope="" itemtype="https://schema.org/Person" class="h-card p-author vcard"><span itemprop="name" class="p-name fn n">{{ $webmention.author_name }}</span></span>
						{{- end -}}
						{{- if $hasContent -}}
							{{- if findRE `^https://brid.gy/[^/]*/mastodon` $webmention.source -}}
							<p role="doc-tip" itemprop="accessibilitySummary">This comment may have major formatting errors that could impact screen reader comprehension.</p>
							{{- end -}}
							<p><q itemprop="text" class="p-content">{{ $webmention.content | replaceRE `^@Seirdy(@pleroma.envs.net)? ?` "" | replaceRE ` \n` `
`}}</q></p>
						{{- end -}}
					{{- end }}
				</dd>
		</div>
		{{- end -}}
	</dl>
</details>
{{ else -}}
<p>This post does not have any approved Webmentions yet.</p>
{{- end }}
<p>Feel free to contact me directly with feedback; <a href="{{ .Site.BaseURL }}about/#location-seirdy-online">here’s my contact info</a></p>

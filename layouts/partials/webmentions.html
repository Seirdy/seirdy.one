{{- $wbmLinks := (slice "https://si3t.ch/log/2021-04-18-entetes-floc.html" "https://xmpp.org/2021/02/newsletter-02-feburary/" "https://gurlic.com/technology/post/393626430212145157" "https://gurlic.com/technology/post/343249858599059461" "https://www.librepunk.club/@penryn/108411423190214816" "https://benign.town/@josias/108457015755310198") -}}
<hr />
<section aria-labelledby="webmentions">
		<h2 id="webmentions" tabindex="-1">Webmen&#173;tions</h2>
		<p>This site supports <a href="https://indieweb.org/webmention">Webmentions</a>, a backlink-based alternative to traditional comment forms.</p>
		{{ partial "webmention-form.html" . }}
		<p>Webmentions received for this post will appear in the following list after I approve them. I sometimes send Webmentions to myself on behalf of linking sites that don't support them. Check the <a href="https://web.archive.org/">Wayback Machine</a> if any links are broken.</p>
		<details>
			<summary>Toggle Webmentions</summary>
			<dl>
				{{- $target := .RelPermalink | replaceRE "^/~seirdy/" "/" }}
				{{- $oldTarget := $target | replaceRE "/posts" "" | replaceRE "/$" ".html" -}}
				{{ $url1 := printf "https://seirdy.one/webmentions/get?status=approved&target=https://seirdy.one%s" $target -}}
				{{ $url2 := printf "https://seirdy.one/webmentions/get?status=approved&target=https://seirdy.one%s" $oldTarget -}}
				{{ $webmentions :=  (getJSON $url1) | append (getJSON $url2) -}}
				{{ range sort $webmentions "created_at" -}}
				{{ $webmention := . -}}
					{{- /* Boolean: should we should handle this webmention like a comment or a linkback? */ -}}
					{{- $hasContent := and (isset $webmention "content") (gt (countrunes $webmention.content) 50) -}}
					{{- $title := $webmention.title -}}
					{{- /* Remove extraneous crap from Fediverse webmentions */ -}}
					{{- if findRE "@Seirdy" $webmention.title -}}
						{{- $title = $title | replaceRE `^@Seirdy@pleroma.envs.net(\n| )?` "" -}}
						{{- /* Mastodon webmentions may include the author in the title followed by a colon; this is redundant. */ -}}
						{{- if and (isset $webmention "author_name") (findRE `@` $webmention.source) (not (findRE "^https://bridg.gy" $webmention.source)) -}}
							{{ $title = $title | replaceRE `^[^:]{0,20}: ?` "" }}
						{{- end -}}
					{{- end -}}
					{{- if and ($hasContent) (gt (countrunes $webmention.title) 128) -}}
						{{- $title = $webmention.title | strings.TrimSuffix "…" | truncate 128 -}}
					{{- end -}}
					{{- $src := $webmention.source -}}
					{{- if in $wbmLinks $src -}}
						{{- $src = printf "https://web.archive.org/web/0/%s" $src -}}
					{{- end -}}
					{{ if (eq $webmention.type "like") -}}
					<div itemprop="potentialAction" itemscope="" itemtype="https://schema.org/LikeAction" class="u-like h-cite">
					{{- else -}}
					<div itemprop="comment" itemscope="" itemtype="https://schema.org/Comment" class="u-comment h-cite">
					{{- end -}}
					<!--Will eventually add role="comment" once WAI-ARIA 1.3 starts seeing some adoption.-->
						<dt>
							<time
								class="dt-published"
								itemprop="{{ if (eq $webmention.type "like") -}}startTime{{ else }}datePublished{{ end }}"
								datetime="{{ dateFormat "2006-01-02 15:04:05Z07:00" $webmention.created_at }}">
								{{ dateFormat "2006-01-02" $webmention.created_at }}
							</time>
						</dt>
						<dd>
							{{ if (eq $webmention.type "like") -}}
								{{ if $webmention.author_name -}}
									<span itemprop="agent" itemscope="" itemtype="https://schema.org/Person" class="h-card p-author vcard"><span itemprop="name" class="p-name fn n">{{ $webmention.author_name }}</span></span>
								{{ else if $webmention.title -}}
									<span itemprop="name" class="p-name">{{ $webmention.title -}}</span>
								{{ else -}}
									{{ $webmention.source | strings.TrimPrefix "https://" | strings.TrimPrefix "www." | strings.TrimRight "/" | truncate 35 -}}
								{{ end -}}
									<a class="u-url" itemprop="url" href="{{ $src }}" rel="nofollow ugc">liked</a> this
							{{ else -}}
								<a class="u-url" itemprop="url" href="{{ $src }}" rel="nofollow ugc">
									<span itemprop="name" class="p-name">
										{{ if $webmention.title -}}
											{{ $title | truncate 200 -}}
										{{ else -}}
											{{- $webmention.source | strings.TrimPrefix "https://" | strings.TrimPrefix "www." | strings.TrimRight "/" | truncate 35 -}}
										{{ end -}}
									</span
								></a>
								{{- if $webmention.author_name }}
								by <span itemprop="author" itemscope="" itemtype="https://schema.org/Person" class="h-card p-author vcard"><span itemprop="name" class="p-name fn n">{{ $webmention.author_name }}</span></span>
								{{- end -}}
								{{- if $hasContent -}}
									{{- if findRE `^https://brid.gy/[^/]*/mastodon` $webmention.source -}}
									<p role="doc-tip" itemprop="accessibilitySummary">This comment may have major formatting errors that could impact screen reader comprehension.</p>
									{{- end -}}
									<p itemprop="articleBody" class="p-content">{{ $webmention.content | replaceRE `^@Seirdy(@pleroma.envs.net)? ?` ""}}</p>
								{{- end -}}
							{{- end }}
						</dd>
				</div>
				{{ else -}}
				<dt>Nothing here</dt>
				<dd>This post does not have any approved Webmentions yet.</dd>
				{{- end }}
			</dl>
		</details>
		<p>Feel free to contact me directly with feedback; <a href="{{ .Site.BaseURL }}about/#location-seirdy-online">here’s my contact info</a></p>
	</section>
